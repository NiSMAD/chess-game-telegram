(function() {
    'use strict';

    window.Chessboard = function(elementOrId, config) {
        const boardEl = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
        const squares = {};
        let position = {};

        const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
        const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];

        function createBoard() {
            boardEl.innerHTML = '';
            for (let r of ranks) {
                for (let f of files) {
                    const square = document.createElement('div');
                    square.classList.add('square-55d63');
                    square.classList.add(((files.indexOf(f) + ranks.indexOf(r)) % 2 === 0) ? 'white-1e1d7' : 'black-3c85d');
                    square.dataset.square = f + r;
                    boardEl.appendChild(square);
                    squares[f + r] = square;
                }
            }
        }

        function clearPieces() {
            for (let sq in squares) {
                squares[sq].innerHTML = '';
            }
        }

        function setPosition(fen) {
            clearPieces();
            const rows = fen.split(' ')[0].split('/');
            let currentRow = 0;
            for (let row of rows) {
                let col = 0;
                for (let ch of row) {
                    if (isFinite(ch)) {
                        col += parseInt(ch);
                    } else {
                        const file = files[col];
                        const rank = ranks[currentRow];
                        const img = document.createElement('img');
                        img.src = getPieceImage(ch);
                        img.draggable = true;
                        img.dataset.piece = ch;
                        squares[file + rank].appendChild(img);
                        col++;
                    }
                }
                currentRow++;
            }
        }

        function getPieceImage(piece) {
            const base = 'https://upload.wikimedia.org/wikipedia/commons/';
            const mapping = {
                'p': 'c/cd/Chess_pdt60.png',
                'r': 'a/a0/Chess_rdt60.png',
                'n': 'f/f1/Chess_ndt60.png',
                'b': '9/98/Chess_bdt60.png',
                'q': '4/47/Chess_qdt60.png',
                'k': 'f/f0/Chess_kdt60.png',
                'P': '4/45/Chess_plt60.png',
                'R': '7/72/Chess_rlt60.png',
                'N': '7/70/Chess_nlt60.png',
                'B': 'b/b1/Chess_blt60.png',
                'Q': '1/15/Chess_qlt60.png',
                'K': '4/42/Chess_klt60.png'
            };
            return base + mapping[piece];
        }

        function init() {
            createBoard();
            if (config && config.position) {
                if (config.position === 'start') {
                    setPosition('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR');
                } else {
                    setPosition(config.position);
                }
            }
        }

        init();

        return {
            position: function(fen) {
                setPosition(fen);
            }
        };
    };
})();
